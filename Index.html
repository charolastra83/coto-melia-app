<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Coto Mel√≠a</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#eef1f3; padding:20px; }
    .card-box {
      background:#fff;
      border-radius:12px;
      padding:20px;
      max-width:720px;
      margin:auto;
      box-shadow:0 2px 12px rgba(0,0,0,.1);
    }
    .hidden { display:none; }
    .titulo {
      font-size:1.3rem;
      font-weight:600;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .pet-img {
      width:48px;
      height:48px;
      border-radius:50%;
      object-fit:cover;
    }
    .badge-soft {
      background:#eef3ff;
      color:#2b4db8;
      border-radius:999px;
      padding:2px 10px;
      font-size:.75rem;
    }
    .text-muted-small { color:#6c757d; font-size:.85rem; }
    .divider { border-top:1px dashed #e2e6ea; margin:12px 0; }
  </style>
</head>

<body>
<div class="card-box">

<!-- LOGIN -->
<div id="stepLogin">
  <div class="titulo mb-3">üèòÔ∏è Administraci√≥n Coto Mel√≠a</div>
  <input id="numero" class="form-control mb-2" placeholder="WhatsApp (solo n√∫meros)">
  <button class="btn btn-primary w-100" onclick="login()">Entrar</button>
</div>

<!-- HOME -->
<div id="stepHome" class="hidden">

  <div class="titulo mb-3">
    <span>üè† Home</span>
    <button class="btn btn-sm btn-outline-secondary" onclick="loadHome()">üîÑ</button>
  </div>

  <div id="homeInfo" class="mb-3"></div>

  <!-- RECIBO -->
  <div class="mb-3">
    <b>üí° Recibo de luz</b><br>
    <span id="reciboEstado"></span>
  </div>

  <!-- MASCOTAS -->
  <div class="mb-3">
    <b>üêæ Mascotas</b>
    <div id="listaMascotas" class="mt-2"></div>
  </div>

  <!-- PAGOS -->
  <div class="mb-3">
    <b>üí∞ Registrar pago</b>

    <select id="p_tipo" class="form-select mt-2">
      <option value="CUOTA">Cuota mensual ($150)</option>
      <option value="PORTON">Port√≥n</option>
      <option value="OTRO">Otro</option>
    </select>

    <input id="p_monto" class="form-control mt-2" value="150">
    <input id="p_arch" type="file" class="form-control mt-2" accept=".jpg,.jpeg,.png,.pdf">

    <button id="btnPago" class="btn btn-primary w-100 mt-2" onclick="enviarPago()">
      Enviar pago
    </button>
    <div class="text-muted-small mt-1">M√°ximo 5MB ‚Ä¢ JPG/PNG/PDF</div>
  </div>

  <!-- √öLTIMO PAGO -->
  <div class="mb-3">
    <b>üßæ √öltimo pago</b>
    <div id="ultimoPago" class="mt-2 text-muted-small">Cargando...</div>
  </div>

  <!-- HISTORIAL DE PAGOS -->
  <div class="mb-3">
    <b>üìö Historial b√°sico</b>
    <div id="historialPagos" class="mt-2 text-muted-small">Cargando...</div>
  </div>

  <!-- FOLIO -->
  <div id="folioBox" class="alert alert-info hidden">
    <div id="folioText"></div>
    <button class="btn btn-outline-primary w-100 mt-2" onclick="aceptarFolio()">
      Aceptar
    </button>
  </div>

</div>
</div>

<script type="module">
import { supabase } from "./supabase.js";

const SESSION = { casa:null };
const MAX_FILE_MB = 5;
const ACCEPTED_RECEIPTS = ["image/jpeg", "image/png", "application/pdf"];

function show(id){ document.getElementById(id).classList.remove("hidden") }
function hide(id){ document.getElementById(id).classList.add("hidden") }
function formatMoney(value){
  return new Intl.NumberFormat("es-MX", { style:"currency", currency:"MXN" }).format(value || 0);
}
function formatDate(value){
  if(!value) return "‚Äî";
  const d = new Date(value);
  return Number.isNaN(d.getTime()) ? "‚Äî" : d.toLocaleString("es-MX");
}
function setPagoLoading(isLoading){
  btnPago.disabled = isLoading;
  p_tipo.disabled = isLoading;
  p_monto.disabled = isLoading;
  p_arch.disabled = isLoading;
  btnPago.innerText = isLoading ? "Enviando..." : "Enviar pago";
}
function validateFile(file){
  if(!file) return "Selecciona un comprobante";
  if(!ACCEPTED_RECEIPTS.includes(file.type)) return "Formato no permitido (usa JPG, PNG o PDF)";
  const maxBytes = MAX_FILE_MB * 1024 * 1024;
  if(file.size > maxBytes) return `Archivo muy grande (m√°x ${MAX_FILE_MB}MB)`;
  return "";
}

/* LOGIN */
async function login(){
  const whatsapp = document.getElementById("numero").value;

  const { data, error } = await supabase
    .from("casas")
    .select("*")
    .eq("whatsapp", whatsapp)
    .single();

  if(error){
    alert("Casa no encontrada");
    return;
  }

  SESSION.casa = data;
  hide("stepLogin");
  loadHome();
}

/* HOME */
async function loadHome(){
  show("stepHome");
  hide("folioBox");

  const { data: casa, error } = await supabase
    .from("casas")
    .select("*")
    .eq("id_unico", SESSION.casa.id_unico)
    .single();

  if(error){
    alert("Error al cargar la casa");
    return;
  }

  SESSION.casa = casa;

  homeInfo.innerHTML = `
    <b>ID Casa:</b> ${casa.id_unico}<br>
    <b>WhatsApp:</b> ${casa.whatsapp}
  `;

  reciboEstado.innerHTML = casa.tiene_recibo
    ? "‚úÖ Recibo de luz completado"
    : "‚ùå Recibo pendiente";

  // Mascotas
  const { data: mascotas } = await supabase
    .from("mascotas")
    .select("*")
    .eq("id_casa", casa.id_unico);

  renderMascotas(mascotas || []);

  await cargarPagos();
}

/* PAGOS: √öLTIMO + HISTORIAL */
async function cargarPagos(){
  const { data: pagos, error } = await supabase
    .from("pagos")
    .select("folio, concepto, monto, created_at, estatus")
    .eq("id_casa", SESSION.casa.id_unico)
    .order("created_at", { ascending: false })
    .limit(5);

  if(error){
    ultimoPago.innerHTML = "No se pudo cargar.";
    historialPagos.innerHTML = "No se pudo cargar.";
    return;
  }

  const ultimo = pagos?.[0];
  ultimoPago.innerHTML = ultimo
    ? `
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="badge-soft">${ultimo.concepto || "Pago"}</span>
        <span>${formatMoney(ultimo.monto)}</span>
        <span class="text-muted-small">${formatDate(ultimo.created_at)}</span>
        ${ultimo.estatus ? `<span class="text-muted-small">‚Ä¢ ${ultimo.estatus}</span>` : ""}
      </div>
      <div class="text-muted-small">Folio: ${ultimo.folio || "‚Äî"}</div>
    `
    : "<i>Sin pagos registrados</i>";

  historialPagos.innerHTML = pagos?.length
    ? pagos.map(p => `
        <div class="d-flex justify-content-between">
          <span>${p.concepto || "Pago"} ‚Ä¢ ${formatDate(p.created_at)}</span>
          <span>${formatMoney(p.monto)}</span>
        </div>
      `).join("<div class='divider'></div>")
    : "<i>Sin pagos registrados</i>";
}

/* MASCOTAS */
function renderMascotas(list){
  listaMascotas.innerHTML = list.length
    ? list.map(m => `
      <div class="d-flex align-items-center gap-2 mb-2">
        <img src="${m.foto_url}" class="pet-img" alt="${m.nombre}">
        <span>${m.nombre} ‚Äì ${m.especie}</span>
      </div>
    `).join("")
    : "<i>Sin mascotas registradas</i>";
}

/* PAGOS */
async function enviarPago(){
  const tipo = p_tipo.value;
  const monto = Number(p_monto.value);
  const file = p_arch.files[0];
  const fileError = validateFile(file);
  if(fileError) return alert(fileError);
  if(!monto || monto <= 0) return alert("Monto inv√°lido");

  setPagoLoading(true);

  // Subir archivo
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, "0");
  const sanitizedName = file.name.replace(/\s+/g, "_");
  const path = `pagos/${SESSION.casa.id_unico}/${year}/${month}/${Date.now()}-${sanitizedName}`;
  const { error: uploadError } = await supabase
    .storage.from("subidas")
    .upload(path, file);

  if(uploadError){
    alert("Error al subir archivo");
    setPagoLoading(false);
    return;
  }

  const { data: urlData } = supabase
    .storage.from("subidas")
    .getPublicUrl(path);

  // Registrar pago
  const { data, error } = await supabase
    .from("pagos")
    .insert({
      id_casa: SESSION.casa.id_unico,
      concepto: tipo,
      monto,
      comprobante_url: urlData.publicUrl
    })
    .select()
    .single();

  if(error){
    alert("Error al registrar pago");
    setPagoLoading(false);
    return;
  }

  folioText.innerHTML = `
    <b>Pago recibido</b><br>
    Folio: <b>${data.folio}</b><br>
    Guarda este comprobante
  `;
  show("folioBox");
}

/* VOLVER A HOME */
function aceptarFolio(){
  setPagoLoading(false);
  p_arch.value = "";
  p_monto.value = "150";
  loadHome();
}

window.login = login;
window.enviarPago = enviarPago;
window.aceptarFolio = aceptarFolio;
window.loadHome = loadHome;
</script>
</body>
</html>

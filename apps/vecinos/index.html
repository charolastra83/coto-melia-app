<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Coto Melía</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --bg: #f3f2f1;
      --card: #ffffff;
      --text: #1b1a19;
      --muted: #605e5c;
      --primary: #0078d4;
      --primary-hover: #106ebe;
      --border: #edebe9;
      --shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      --radius: 10px;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      padding: 20px;
      font-family: "Segoe UI", "Segoe UI Variable", "Segoe UI Web", Tahoma, Geneva, Verdana, sans-serif;
    }
    .card-box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      max-width: 900px;
      margin: auto;
      box-shadow: var(--shadow);
    }
    .hidden { display: none; }
    .titulo {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pet-img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      background: #f8f7f6;
      border: 1px solid var(--border);
    }
    .pendiente { color: #a4262c; font-weight: 600; }
    .btn-primary,
    .btn-outline-primary {
      border-radius: 8px;
      font-weight: 600;
    }
    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
    }
    .btn-primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
    }
    .btn-outline-primary {
      color: var(--primary);
      border-color: var(--primary);
    }
    .btn-outline-primary:hover {
      color: #fff;
      background: var(--primary);
      border-color: var(--primary);
    }
    .form-control,
    .form-select {
      border-radius: 8px;
      border-color: var(--border);
      box-shadow: none;
    }
    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(0, 120, 212, 0.15);
    }
    .alert {
      border-radius: 10px;
      border-color: var(--border);
    }
  </style>
</head>

<body>
<div class="card-box">

<!-- LOGIN -->
<div id="stepLogin">
<div id="stepLogin">
  <div class="titulo mb-3">?? Administración Coto Melía</div>
  <input id="loginWhatsapp" class="form-control mb-2" placeholder="WhatsApp (solo números)">
  <button id="btnLogin" class="btn btn-primary w-100" onclick="login()">Entrar</button>
</div>

<!-- REGISTRO -->
<div id="stepRegistro" class="hidden">
  <div class="titulo mb-3">?? Registro de casa</div>

  <div class="row g-2">
    <div class="col-md-6">
      <input id="regNombre" class="form-control" placeholder="Nombre">
    </div>
    <div class="col-md-6">
      <input id="regApellido" class="form-control" placeholder="Apellido">
    </div>
    <div class="col-md-8">
      <input id="regCalle" class="form-control" placeholder="Calle">
    </div>
    <div class="col-md-4">
      <input id="regNumero" class="form-control" placeholder="Número">
    </div>
    <div class="col-md-6">
      <select id="regTipo" class="form-select">
        <option value="">Tipo de casa</option>
        <option value="CASA">Casa</option>
        <option value="DUPLEX">Dúplex</option>
      </select>
    </div>
    <div class="col-md-6">
      <select id="regTenencia" class="form-select">
        <option value="">Tenencia</option>
        <option value="PROPIETARIO">Propietario</option>
        <option value="RENTA">Renta</option>
      </select>
    </div>
    <div class="col-md-6">
      <input id="regInterior" class="form-control" placeholder="Interior (solo dúplex)">
    </div>
  </div>

  <div class="mt-3">
    <button id="btnRegistro" class="btn btn-primary w-100" onclick="registrarCasa()">Registrar</button>
  </div>
</div>

<!-- HOME -->
<div id="stepHome" class="hidden">
  <div class="titulo mb-3">
    <span>?? Inicio</span>
    <button class="btn btn-sm btn-outline-secondary" onclick="loadHome()">?</button>
  </div>

  <div id="homeInfo" class="mb-3"></div>
  <div id="homeInfo" class="mb-3"></div>
  <div id="pendientesForm" class="mb-3"></div>

  <!-- RECIBO -->
  <div class="mb-4">
    <b>?? Recibo de luz</b><br>
    <div id="reciboEstado" class="mb-2"></div>

    <div id="reciboUploadBox" class="mt-2">
      <input id="reciboArchivo" type="file" class="form-control" accept="image/*,.pdf">
      <button id="btnRecibo" class="btn btn-outline-primary w-100 mt-2" onclick="subirRecibo()">Subir recibo</button>
    </div>
  </div>

  <!-- MASCOTAS -->
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <b>?? Mascotas</b>
      <button class="btn btn-sm btn-outline-secondary" onclick="toggleMascotaForm()">? Agregar mascota</button>
    </div>
    <div id="listaMascotas" class="mt-2"></div>

    <div id="formMascota" class="mt-3 hidden">
      <div class="row g-2">
        <div class="col-md-4">
          <input id="mascotaNombre" class="form-control" placeholder="Nombre">
        </div>
        <div class="col-md-4">
          <input id="mascotaEspecie" class="form-control" placeholder="Especie">
        </div>
        <div class="col-md-4">
          <input id="mascotaRaza" class="form-control" placeholder="Raza">
        </div>
        <div class="col-12">
          <input id="mascotaFoto" type="file" class="form-control" accept="image/*">
        </div>
      </div>
      <button id="btnMascota" class="btn btn-primary w-100 mt-2" onclick="guardarMascota()">Guardar mascota</button>
    </div>
  </div>

  <!-- PAGOS -->
  <div class="mb-3">
    <b>?? Pagos</b>
    <div id="pagoResumen" class="mt-2"></div>

    <div class="mt-3">
      <select id="pagoTipo" class="form-select" onchange="onTipoPagoChange()">
        <option value="CUOTA">Cuota mensual ($150 pesos)</option>
        <option value="PORTON">Portón ($1,500 pesos)</option>
        <option value="MULTA">Multa</option>
        <option value="OTRO">Otro</option>
      </select>

      <select id="pagoMes" class="form-select mt-2"></select>

      <input id="pagoMonto" class="form-control mt-2" value="150" type="number" min="1">
      <div id="pagoMontoDisplay" class="text-muted small"></div>
      <input id="pagoConcepto" class="form-control mt-2" placeholder="Concepto (obligatorio para OTRO)">
      <input id="pagoArchivo" type="file" class="form-control mt-2" accept="image/*,.pdf">

      <button id="btnPago" class="btn btn-primary w-100 mt-2" onclick="registrarPago()">Enviar pago</button>
    </div>
  </div>

  <!-- FOLIO -->
  <div id="folioBox" class="alert alert-info hidden">
    <div id="folioText"></div>
    <button class="btn btn-outline-primary w-100 mt-2" onclick="aceptarFolio()">Aceptar</button>
  </div>
</div>
</div>

<script type="module">
import { supabase } from "../../shared/supabase.js";
import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.2.67/build/pdf.min.mjs";

pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.2.67/build/pdf.worker.min.mjs";

const SESSION = { casa: null, pagos: [], recibo: null, mascotas: [] };

const ui = {
  stepLogin: document.getElementById("stepLogin"),
  stepRegistro: document.getElementById("stepRegistro"),
  stepHome: document.getElementById("stepHome"),
  loginWhatsapp: document.getElementById("loginWhatsapp"),
  btnLogin: document.getElementById("btnLogin"),
  regNombre: document.getElementById("regNombre"),
  regApellido: document.getElementById("regApellido"),
  regCalle: document.getElementById("regCalle"),
  regNumero: document.getElementById("regNumero"),
  regTipo: document.getElementById("regTipo"),
  regTenencia: document.getElementById("regTenencia"),
  regInterior: document.getElementById("regInterior"),
  btnRegistro: document.getElementById("btnRegistro"),
  homeInfo: document.getElementById("homeInfo"),
  regTipo: document.getElementById("regTipo"),
  regTenencia: document.getElementById("regTenencia"),
  regInterior: document.getElementById("regInterior"),
  btnRegistro: document.getElementById("btnRegistro"),
  homeInfo: document.getElementById("homeInfo"),
  pendientesForm: document.getElementById("pendientesForm"),
  reciboEstado: document.getElementById("reciboEstado"),
  reciboUploadBox: document.getElementById("reciboUploadBox"),
  reciboArchivo: document.getElementById("reciboArchivo"),
  btnRecibo: document.getElementById("btnRecibo"),
  listaMascotas: document.getElementById("listaMascotas"),
  formMascota: document.getElementById("formMascota"),
  mascotaNombre: document.getElementById("mascotaNombre"),
  mascotaEspecie: document.getElementById("mascotaEspecie"),
  mascotaRaza: document.getElementById("mascotaRaza"),
  mascotaFoto: document.getElementById("mascotaFoto"),
  btnMascota: document.getElementById("btnMascota"),
  pagoResumen: document.getElementById("pagoResumen"),
  pagoTipo: document.getElementById("pagoTipo"),
  pagoMes: document.getElementById("pagoMes"),
  pagoMonto: document.getElementById("pagoMonto"),
  pagoMontoDisplay: document.getElementById("pagoMontoDisplay"),
  pagoConcepto: document.getElementById("pagoConcepto"),
  pagoArchivo: document.getElementById("pagoArchivo"),
  btnPago: document.getElementById("btnPago"),
  folioBox: document.getElementById("folioBox"),
  folioText: document.getElementById("folioText")
};

const MESES_2026 = [
  "ENERO-2026",
  "FEBRERO-2026",
  "MARZO-2026",
  "ABRIL-2026",
  "MAYO-2026",
  "JUNIO-2026",
  "JULIO-2026",
  "AGOSTO-2026",
  "SEPTIEMBRE-2026",
  "OCTUBRE-2026",
  "NOVIEMBRE-2026",
  "DICIEMBRE-2026"
];

const CUOTA_TOTAL = 1800;
const CUOTA_MENSUAL = 150;
const PORTON_MAX = 1500;

function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }
function normalizarWhatsapp(valor){ return (valor || "").replace(/\D/g, ""); }

function normalizarTexto(valor){
  return (valor || "")
    .toUpperCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-")
    .trim();
}

function generarIdUnico(calle, numero, tipoCasa, interior){
  const base = `${normalizarTexto(calle)}-${normalizarTexto(numero)}`;
  if (tipoCasa === "DUPLEX") {
    return `${base}-${normalizarTexto(interior)}`;
  }
  return base;
}

function formatearDinero(valor){
  const formato = new Intl.NumberFormat("es-MX", {
    style: "currency",
    currency: "MXN",
    maximumFractionDigits: 0
  }).format(valor || 0);
  return `${formato} pesos`;
}

function generarFolio(){
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, "0");
  const d = String(now.getDate()).padStart(2, "0");
  const rand = String(Math.floor(Math.random() * 10000)).padStart(4, "0");
  return `PAGO-${y}${m}${d}-${rand}`;
}

async function resizeImage(file, maxSize = 1280, quality = 0.7){
  return new Promise((resolve) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = () => { img.src = reader.result; };
    reader.onerror = () => resolve(file);
    img.onload = () => {
      let { width, height } = img;
      if (width > maxSize || height > maxSize) {
        const scale = Math.min(maxSize / width, maxSize / height);
        width = Math.round(width * scale);
        height = Math.round(height * scale);
      }
      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);
      canvas.toBlob((blob) => {
        if (!blob) return resolve(file);
        resolve(new File([blob], file.name.replace(/\.[^/.]+$/, ".jpg"), { type: "image/jpeg" }));
      }, "image/jpeg", quality);
    };
    reader.readAsDataURL(file);
  });
}

async function pdfToJpeg(file){
  const data = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data }).promise;
  const page = await pdf.getPage(1);
  const viewport = page.getViewport({ scale: 2 });
  const canvas = document.createElement("canvas");
  canvas.width = viewport.width;
  canvas.height = viewport.height;
  const ctx = canvas.getContext("2d");
  await page.render({ canvasContext: ctx, viewport }).promise;

  return new Promise((resolve, reject) => {
    canvas.toBlob((blob) => {
      if (!blob) {
        reject(new Error("No se pudo convertir el PDF"));
        return;
      }
      const nombre = file.name.replace(/\.pdf$/i, ".jpg");
      resolve(new File([blob], nombre, { type: "image/jpeg" }));
    }, "image/jpeg", 0.8);
  });
}

function pendientesCasa(casa){
  const pendientes = [];
  if (!casa.nombre) pendientes.push("Nombre");
  if (!casa.apellido) pendientes.push("Apellido");
  if (!casa.calle) pendientes.push("Calle");
  if (!casa.numero) pendientes.push("Número");
  if (!casa.tipo_casa) pendientes.push("Tipo de casa");
  if (!casa.tenencia) pendientes.push("Tenencia");
  if (casa.tipo_casa === "DUPLEX" && !casa.interior) pendientes.push("Interior");
  return pendientes;
}

function renderInfoCasa(casa){
  const nombre = casa.nombre && casa.apellido
    ? `${casa.nombre} ${casa.apellido}`
    : "Pendiente de llenar";
  const direccion = casa.calle && casa.numero
    ? `${casa.calle} ${casa.numero}${casa.interior ? " - " + casa.interior : ""}`
    : "Pendiente de llenar";
  const pendientes = pendientesCasa(casa);

  ui.homeInfo.innerHTML = `
    <b>ID Casa:</b> ${casa.id_unico}<br>
    <b>Nombre:</b> ${nombre}<br>
    <b>Dirección:</b> ${direccion}<br>
    <b>Tenencia:</b> ${casa.tenencia || "Pendiente de llenar"}<br>
    <b>WhatsApp:</b> ${casa.whatsapp}<br>
    <b>Pendientes:</b> ${pendientes.length ? `<span class="pendiente">${pendientes.join(", ")}</span>` : "Ninguno"}
  `;

  renderPendientesForm(casa, pendientes);
}


function renderPendientesForm(casa, pendientes){
  if (!pendientes.length) {
    ui.pendientesForm.innerHTML = "";
    return;
  }

  let html = `
    <div class="border rounded p-3">
      <div class="mb-2"><b>Completa tus datos pendientes</b></div>
  `;

  if (!casa.nombre) {
    html += `
      <label class="form-label">Nombre</label>
      <input id="pendienteNombre" class="form-control mb-2" type="text" placeholder="Nombre">
    `;
  }

  if (!casa.apellido) {
    html += `
      <label class="form-label">Apellido</label>
      <input id="pendienteApellido" class="form-control mb-2" type="text" placeholder="Apellido">
    `;
  }

  if (!casa.calle) {
    html += `
      <label class="form-label">Calle</label>
      <input id="pendienteCalle" class="form-control mb-2" type="text" placeholder="Calle">
    `;
  }

  if (!casa.numero) {
    html += `
      <label class="form-label">Número</label>
      <input id="pendienteNumero" class="form-control mb-2" type="text" placeholder="Número">
    `;
  }

  if (!casa.tipo_casa) {
    html += `
      <label class="form-label">Tipo de casa</label>
      <select id="pendienteTipoCasa" class="form-select mb-2">
        <option value="">Selecciona</option>
        <option value="CASA">Casa</option>
        <option value="DUPLEX">Dúplex</option>
      </select>
    `;
  }

  if (!casa.tenencia) {
    html += `
      <label class="form-label">Tenencia</label>
      <select id="pendienteTenencia" class="form-select mb-2">
        <option value="">Selecciona</option>
        <option value="PROPIETARIO">Propietario</option>
        <option value="RENTA">Renta</option>
      </select>
    `;
  }

  const necesitaInterior = casa.tipo_casa === "DUPLEX" || !casa.tipo_casa;
  if (necesitaInterior && !casa.interior) {
    const claseInterior = casa.tipo_casa === "DUPLEX" ? "mb-2" : "mb-2 hidden";
    html += `
      <div id="pendienteInteriorBox" class="${claseInterior}">
        <label class="form-label">Interior (solo dúplex)</label>
        <input id="pendienteInterior" class="form-control" type="text" placeholder="Interior">
      </div>
    `;
  }

  html += `
      <button id="btnGuardarPendientes" class="btn btn-outline-primary w-100">Guardar</button>
    </div>
  `;

  ui.pendientesForm.innerHTML = html;

  const tipoSelect = document.getElementById("pendienteTipoCasa");
  if (tipoSelect) {
    tipoSelect.addEventListener("change", togglePendienteInterior);
    togglePendienteInterior();
  }

  const btnGuardar = document.getElementById("btnGuardarPendientes");
  if (btnGuardar) {
    btnGuardar.addEventListener("click", guardarPendientes);
  }
}

function togglePendienteInterior(){
  const tipoSelect = document.getElementById("pendienteTipoCasa");
  const interiorBox = document.getElementById("pendienteInteriorBox");
  const interiorInput = document.getElementById("pendienteInterior");
  if (!tipoSelect || !interiorBox) return;

  if (tipoSelect.value === "DUPLEX") {
    interiorBox.classList.remove("hidden");
  } else {
    interiorBox.classList.add("hidden");
    if (interiorInput) interiorInput.value = "";
  }
}

async function guardarPendientes(){
  const updates = {};

  const nombreEl = document.getElementById("pendienteNombre");
  if (nombreEl) {
    const valor = nombreEl.value.trim();
    if (!valor) {
      alert("Completa el nombre");
      return;
    }
    updates.nombre = valor;
  }

  const apellidoEl = document.getElementById("pendienteApellido");
  if (apellidoEl) {
    const valor = apellidoEl.value.trim();
    if (!valor) {
      alert("Completa el apellido");
      return;
    }
    updates.apellido = valor;
  }

  const calleEl = document.getElementById("pendienteCalle");
  if (calleEl) {
    const valor = calleEl.value.trim();
    if (!valor) {
      alert("Completa la calle");
      return;
    }
    updates.calle = valor;
  }

  const numeroEl = document.getElementById("pendienteNumero");
  if (numeroEl) {
    const valor = numeroEl.value.trim();
    if (!valor) {
      alert("Completa el número");
      return;
    }
    updates.numero = valor;
  }

  const tipoEl = document.getElementById("pendienteTipoCasa");
  if (tipoEl) {
    const valor = tipoEl.value;
    if (!valor) {
      alert("Selecciona el tipo de casa");
      return;
    }
    updates.tipo_casa = valor;
    if (valor === "CASA") updates.interior = null;
  }

  const tenenciaEl = document.getElementById("pendienteTenencia");
  if (tenenciaEl) {
    const valor = tenenciaEl.value;
    if (!valor) {
      alert("Selecciona la tenencia");
      return;
    }
    updates.tenencia = valor;
  }

  const interiorEl = document.getElementById("pendienteInterior");
  if (interiorEl) {
    const tipoActual = tipoEl ? tipoEl.value : SESSION.casa.tipo_casa;
    const valor = interiorEl.value.trim();
    if (tipoActual === "DUPLEX") {
      if (!valor) {
        alert("Captura el interior");
        return;
      }
      updates.interior = valor;
    } else if (tipoActual === "CASA") {
      updates.interior = null;
    }
  }

  if (!Object.keys(updates).length) {
    return;
  }

  try {
    const { error } = await supabase
      .from("casas")
      .update(updates)
      .eq("id", SESSION.casa.id);

    if (error) {
      console.error("Error al actualizar perfil", error);
      alert("Error al actualizar el perfil");
      return;
    }

    SESSION.casa = { ...SESSION.casa, ...updates };
    renderInfoCasa(SESSION.casa);
  } catch (err) {
    alert("Error al actualizar el perfil");
  }
}
}
function renderRecibo(){
  if (SESSION.recibo) {
    const periodo = SESSION.recibo.periodo ? `Periodo: ${SESSION.recibo.periodo}` : "";
    const total = SESSION.recibo.total ? `Total: ${formatearDinero(SESSION.recibo.total)}` : "";
    const titular = SESSION.recibo.titular ? `Titular: ${SESSION.recibo.titular}` : "Titular: Pendiente";
    const contrato = SESSION.recibo.numero_contrato ? `Contrato: ${SESSION.recibo.numero_contrato}` : "Contrato: Pendiente";
    const medidor = SESSION.recibo.numero_medidor ? `Medidor: ${SESSION.recibo.numero_medidor}` : "Medidor: Pendiente";
    const extra = [periodo, total].filter(Boolean).join(" | ");

    ui.reciboEstado.innerHTML = `? Recibo completado${extra ? "<br>" + extra : ""}<br>${titular}<br>${contrato}<br>${medidor}`;
    hide(ui.reciboUploadBox);
  } else {
    ui.reciboEstado.innerHTML = "? Recibo pendiente";
    show(ui.reciboUploadBox);
  }
}

function renderMascotas(){
  if (!SESSION.mascotas.length) {
    ui.listaMascotas.innerHTML = "<i>Sin mascotas registradas</i>";
    return;
  }

  ui.listaMascotas.innerHTML = SESSION.mascotas.map((m) => `
    <div class="d-flex align-items-center gap-2 mb-2">
      <img src="${m.foto_url || ""}" class="pet-img" onerror="this.removeAttribute('src'); this.classList.add('bg-light');">
      <div>
        <div><b>${m.nombre || ""}</b></div>
        <div>${m.especie || ""}${m.raza ? " - " + m.raza : ""}</div>
      </div>
    </div>
  `).join("");
}

function sumPagos(tipo, estatus){
  return SESSION.pagos
    .filter((p) => p.tipo === tipo && p.estatus === estatus)
    .reduce((sum, p) => sum + Number(p.monto || 0), 0);
}

function mesesCuotaDisponibles(){
  const usados = new Set(
    SESSION.pagos
      .filter((p) => p.tipo === "CUOTA" && p.mes && p.estatus !== "RECHAZADO")
      .map((p) => p.mes)
  );
  return MESES_2026.filter((mes) => !usados.has(mes));
}

function renderPagos(){
  if (!SESSION.pagos.length) {
    ui.pagoResumen.innerHTML = "<i>Sin pagos registrados</i>";
  } else {
    const ultimo = SESSION.pagos[0];
    const estado = ultimo.estatus === "VALIDADO" ? "Validado" : "Pendiente de validación";
    ui.pagoResumen.innerHTML = `
      <div><b>Último pago:</b> ${ultimo.tipo} ${ultimo.mes ? "(" + ultimo.mes + ")" : ""} - ${formatearDinero(ultimo.monto)}</div>
      <div class="text-muted">Folio: ${ultimo.folio} | ${estado}</div>
    `;
  }

  const cuotaValidado = sumPagos("CUOTA", "VALIDADO");
  const cuotaPendiente = sumPagos("CUOTA", "PENDIENTE");
  const cuotaRestante = Math.max(0, CUOTA_TOTAL - cuotaValidado);

  const portonValidado = sumPagos("PORTON", "VALIDADO");
  const portonPendiente = sumPagos("PORTON", "PENDIENTE");
  const portonRestante = Math.max(0, PORTON_MAX - portonValidado);

  const resumenTotales = `
    <div class="mt-2">
      <div><b>Cuota:</b> Validado ${formatearDinero(cuotaValidado)} | Pendiente ${formatearDinero(cuotaPendiente)} | Saldo ${formatearDinero(cuotaRestante)}</div>
      <div><b>Portón:</b> Validado ${formatearDinero(portonValidado)} | Pendiente ${formatearDinero(portonPendiente)} | Saldo ${formatearDinero(portonRestante)}</div>
    </div>
  `;

  const historial = SESSION.pagos.map((p) => {
    const estado = p.estatus === "VALIDADO" ? "Validado" : "Pendiente de validación";
    return `
      <div class="border-top pt-2 mt-2">
        <div>${p.tipo}${p.mes ? " - " + p.mes : ""} | ${formatearDinero(p.monto)}</div>
        <div class="text-muted">Folio: ${p.folio} | ${estado}</div>
      </div>
    `;
  }).join("");

  ui.pagoResumen.innerHTML += resumenTotales + (historial ? `<div class="mt-2">${historial}</div>` : "");
}

function actualizarMesesCuota(){
  const disponibles = mesesCuotaDisponibles();
  if (!disponibles.length) {
    ui.pagoMes.innerHTML = `<option value="" disabled selected>Sin meses disponibles</option>`;
    return;
  }

  ui.pagoMes.innerHTML = disponibles
    .map((mes) => `<option value="${mes}">${mes}</option>`)
    .join("");

  if (!disponibles.includes(ui.pagoMes.value)) {
    ui.pagoMes.value = disponibles[0];
  }
}

function validarReglasPago(){
  const tipo = ui.pagoTipo.value;
  const totalCuotaValidado = sumPagos("CUOTA", "VALIDADO");
  const totalPortonValidado = sumPagos("PORTON", "VALIDADO");
  const cuotaDisponible = mesesCuotaDisponibles().length > 0;

  const cuotaCubierta = totalCuotaValidado >= CUOTA_TOTAL;
  const portonCubierto = totalPortonValidado >= PORTON_MAX;

  if (tipo === "CUOTA") {
    ui.pagoMonto.value = CUOTA_MENSUAL;
    ui.pagoMonto.disabled = true;
    ui.pagoMes.disabled = cuotaCubierta || !cuotaDisponible;
  } else {
    ui.pagoMonto.disabled = false;
    ui.pagoMes.disabled = true;
    ui.pagoMes.value = "";
  }

  if (tipo === "PORTON") {
    ui.pagoMonto.min = 1;
    ui.pagoMonto.max = PORTON_MAX;
    if (!ui.pagoMonto.value || Number(ui.pagoMonto.value) === CUOTA_MENSUAL) {
      ui.pagoMonto.value = PORTON_MAX;
    }
  } else {
    ui.pagoMonto.min = 1;
    ui.pagoMonto.max = "";
  }

  if (tipo === "OTRO") {
    ui.pagoConcepto.disabled = false;
  } else {
    ui.pagoConcepto.disabled = true;
    ui.pagoConcepto.value = "";
  }

  const bloqueado = (tipo === "CUOTA" && cuotaCubierta) || (tipo === "PORTON" && portonCubierto);
  ui.btnPago.disabled = bloqueado;

  if (bloqueado) {
    ui.btnPago.textContent = "Pago bloqueado";
  } else {
    ui.btnPago.textContent = "Enviar pago";
  }

  actualizarPagoMontoDisplay();
}

function onTipoPagoChange(){
  actualizarMesesCuota();
  validarReglasPago();
}

function actualizarPagoMontoDisplay(){
  const monto = Number(ui.pagoMonto.value || 0);
  ui.pagoMontoDisplay.textContent = `Monto: ${formatearDinero(monto)}`;
}

async function invocarReciboOCR(path){
  const { data, error } = await supabase.functions.invoke("recibo-ocr", {
    body: { bucket: "uploads", path }
  });

  if (error) {
    console.error("Error OCR", error);
    return { titular: null, numero_contrato: null, numero_medidor: null };
  }

  let texto = "";
  if (typeof data === "string") {
    texto = data;
  } else if (data && typeof data === "object" && data.text) {
    texto = data.text;
  }

  const partes = texto.split("|").map((p) => p.trim());
  return {
    titular: partes[0] || null,
    numero_contrato: partes[1] || null,
    numero_medidor: partes[2] || null
  };
}

/* LOGIN */
async function login(){
  const whatsapp = normalizarWhatsapp(ui.loginWhatsapp.value);
  if (!whatsapp) {
    alert("Ingresa un WhatsApp válido");
    return;
  }

  ui.btnLogin.disabled = true;

  try {
    const { data, error } = await supabase
      .from("casas")
      .select("*")
      .eq("whatsapp", whatsapp)
      .maybeSingle();

    if (error) {
      console.error("Error al buscar casa", error);
      alert("Error al buscar la casa");
      return;
    }

    if (!data) {
      SESSION.casa = { whatsapp };
      hide(ui.stepLogin);
      show(ui.stepRegistro);
      return;
    }

    SESSION.casa = data;
    hide(ui.stepLogin);
    await loadHome();
  } finally {
    ui.btnLogin.disabled = false;
  }
}

/* REGISTRO */
async function registrarCasa(){
  const nombre = ui.regNombre.value.trim();
  const apellido = ui.regApellido.value.trim();
  const calle = ui.regCalle.value.trim();
  const numero = ui.regNumero.value.trim();
  const tipoCasa = ui.regTipo.value;
  const tenencia = ui.regTenencia.value;
  const tipoCasa = ui.regTipo.value;
  const tenencia = ui.regTenencia.value;
  const interior = ui.regInterior.value.trim();

  if (!nombre || !apellido || !calle || !numero || !tipoCasa || !tenencia) {
    alert("Completa todos los campos obligatorios");
    return;
  }

  if (tipoCasa === "DUPLEX" && !interior) {
    alert("El interior es obligatorio para dúplex");
    return;
  }

  if (tipoCasa === "CASA" && interior) {
    alert("No debes capturar interior para casa");
    return;
  }

  const idUnico = generarIdUnico(calle, numero, tipoCasa, interior);

  ui.btnRegistro.disabled = true;

  try {
    const { data: existeId, error: errorId } = await supabase
      .from("casas")
      .select("id")
      .eq("id_unico", idUnico)
      .maybeSingle();

    if (errorId) {
      console.error("Error al validar id_unico", errorId);
      alert("Error al validar la casa");
      return;
    }

    if (existeId) {
      alert("Ya existe una casa con ese domicilio");
      return;
    }

    const { data: nuevaCasa, error: insertError } = await supabase
      .from("casas")
      .insert({
        whatsapp: SESSION.casa.whatsapp,
        nombre,
        apellido,
        calle,
        numero,
        tipo_casa: tipoCasa,
        tenencia,
        tipo_casa: tipoCasa,
        tenencia,
        interior: tipoCasa === "DUPLEX" ? interior : null,
        id_unico: idUnico
      })
      .select("*")
      .single();

    if (insertError) {
      console.error("Error al registrar casa", insertError);
      alert("Error al registrar la casa");
      return;
    }

    SESSION.casa = nuevaCasa;
    hide(ui.stepRegistro);
    await loadHome();
  } finally {
    ui.btnRegistro.disabled = false;
  }
}

/* HOME */
async function loadHome(){
  show(ui.stepHome);
  hide(ui.folioBox);

  if (!SESSION.casa) return;

  const { data: casaData, error: casaError } = await supabase
    .from("casas")
    .select("*")
    .eq("id", SESSION.casa.id)
    .maybeSingle();

  if (!casaError && casaData) {
    SESSION.casa = casaData;
  }

  renderInfoCasa(SESSION.casa);

  const { data: recibo, error: reciboError } = await supabase
    .from("recibos_luz")
    .select("*")
    .eq("casa_id", SESSION.casa.id)
    .maybeSingle();

  if (reciboError) {
    console.error("Error al cargar recibo", reciboError);
    SESSION.recibo = null;
  } else {
    SESSION.recibo = recibo || null;
  }

  const { data: mascotas, error: mascotasError } = await supabase
    .from("mascotas")
    .select("*")
    .eq("casa_id", SESSION.casa.id)
    .order("created_at", { ascending: false });

  if (mascotasError) {
    console.error("Error al cargar mascotas", mascotasError);
    SESSION.mascotas = [];
  } else {
    SESSION.mascotas = mascotas || [];
  }

  const { data: pagos, error: pagosError } = await supabase
    .from("pagos")
    .select("*")
    .eq("casa_id", SESSION.casa.id)
    .order("created_at", { ascending: false });

  if (pagosError) {
    console.error("Error al cargar pagos", pagosError);
    SESSION.pagos = [];
  } else {
    SESSION.pagos = (pagos || []).filter((p) => p.estatus !== "ELIMINADO");
  }

  renderRecibo();
  renderMascotas();
  renderPagos();
  actualizarMesesCuota();
  validarReglasPago();
}

/* RECIBO */
async function subirRecibo(){
  if (SESSION.recibo) {
    alert("Ya existe un recibo registrado");
    return;
  }

  const file = ui.reciboArchivo.files[0];
  if (!file) {
    alert("Selecciona un archivo");
    return;
  }

  ui.btnRecibo.disabled = true;

  try {
    let archivoFinal = file;
    if (file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf")) {
      archivoFinal = await pdfToJpeg(file);
    } else if (file.type.startsWith("image/")) {
      archivoFinal = await resizeImage(file, 1280, 0.7);
    }

    const extension = archivoFinal.name.split(".").pop();
    const path = `casas/${SESSION.casa.id_unico}/recibos/${Date.now()}.${extension}`;

    const { error: uploadError } = await supabase
      .storage.from("uploads")
      .upload(path, archivoFinal, { upsert: false });

    if (uploadError) {
      console.error("Error al subir recibo", uploadError);
      alert("Error al subir el recibo");
      return;
    }

    const { data: urlData } = supabase.storage.from("uploads").getPublicUrl(path);
    const ocr = await invocarReciboOCR(path);

    const { data: nuevoRecibo, error: insertError } = await supabase
      .from("recibos_luz")
      .insert({
        casa_id: SESSION.casa.id,
        archivo_url: urlData.publicUrl,
        titular: ocr.titular,
        numero_contrato: ocr.numero_contrato,
        numero_medidor: ocr.numero_medidor
      })
      .select("*")
      .single();

    if (insertError) {
      console.error("Error al registrar recibo", insertError);
      alert("Error al registrar el recibo");
      return;
    }

    SESSION.recibo = nuevoRecibo;
    renderRecibo();
  } finally {
    ui.btnRecibo.disabled = false;
  }
}

/* MASCOTAS */
function toggleMascotaForm(){
  ui.formMascota.classList.toggle("hidden");
}

async function guardarMascota(){
  const nombre = ui.mascotaNombre.value.trim();
  const especie = ui.mascotaEspecie.value.trim();
  const raza = ui.mascotaRaza.value.trim();
  const file = ui.mascotaFoto.files[0];

  if (!nombre || !especie) {
    alert("Nombre y especie son obligatorios");
    return;
  }

  ui.btnMascota.disabled = true;

  try {
    let fotoUrl = null;
    if (file) {
      let archivoFinal = file;
      if (file.type.startsWith("image/")) {
        archivoFinal = await resizeImage(file, 512, 0.8);
      }

      const extension = archivoFinal.name.split(".").pop();
      const path = `casas/${SESSION.casa.id_unico}/mascotas/${Date.now()}.${extension}`;

      const { error: uploadError } = await supabase
        .storage.from("uploads")
        .upload(path, archivoFinal, { upsert: false });

      if (uploadError) {
        console.error("Error al subir foto", uploadError);
        alert("Error al subir la foto");
        return;
      }

      const { data: urlData } = supabase.storage.from("uploads").getPublicUrl(path);
      fotoUrl = urlData.publicUrl;
    }

    const { error: insertError } = await supabase
      .from("mascotas")
      .insert({
        casa_id: SESSION.casa.id,
        nombre,
        especie,
        raza,
        foto_url: fotoUrl
      });

    if (insertError) {
      console.error("Error al guardar mascota", insertError);
      alert("Error al guardar mascota");
      return;
    }

    ui.mascotaNombre.value = "";
    ui.mascotaEspecie.value = "";
    ui.mascotaRaza.value = "";
    ui.mascotaFoto.value = "";
    hide(ui.formMascota);
    await loadHome();
  } finally {
    ui.btnMascota.disabled = false;
  }
}

/* PAGOS */
async function registrarPago(){
  const tipo = ui.pagoTipo.value;
  const monto = Number(ui.pagoMonto.value);
  const mes = tipo === "CUOTA" ? ui.pagoMes.value : null;
  const concepto = tipo === "OTRO" ? ui.pagoConcepto.value.trim() : null;
  const file = ui.pagoArchivo.files[0];

  if (tipo === "CUOTA" && !mes) {
    alert("Selecciona un mes para la cuota");
    return;
  }

  if (tipo === "CUOTA") {
    const mesYaRegistrado = SESSION.pagos.some(
      (p) => p.tipo === "CUOTA" && p.mes === mes && p.estatus !== "RECHAZADO"
    );
    if (mesYaRegistrado) {
      alert("Ese mes ya tiene un pago registrado");
      actualizarMesesCuota();
      validarReglasPago();
      return;
    }
  }

  if (tipo === "OTRO" && !concepto) {
    alert("Debes agregar un concepto");
    return;
  }

  if (!monto || monto < 1) {
    alert("Monto inválido");
    return;
  }

  const totalCuotaValidado = sumPagos("CUOTA", "VALIDADO");
  const totalPortonValidado = sumPagos("PORTON", "VALIDADO");

  if (tipo === "CUOTA" && totalCuotaValidado >= CUOTA_TOTAL) {
    alert("La cuota anual ya está cubierta");
    return;
  }

  if (tipo === "PORTON" && totalPortonValidado >= PORTON_MAX) {
    alert("El pago de portón ya está cubierto");
    return;
  }

  if (tipo === "PORTON" && monto + totalPortonValidado > PORTON_MAX) {
    alert("El monto excede el máximo acumulado de portón");
    return;
  }

  const folio = generarFolio();

  ui.btnPago.disabled = true;

  try {
    let comprobanteUrl = null;
    if (file) {
      const extension = file.name.split(".").pop();
      const path = `casas/${SESSION.casa.id_unico}/pagos/folios/${folio}.${extension}`;

      const { error: uploadError } = await supabase
        .storage.from("uploads")
        .upload(path, file, { upsert: false });

      if (uploadError) {
        console.error("Error al subir comprobante", uploadError);
        alert("Error al subir el comprobante");
        return;
      }

      const { data: urlData } = supabase.storage.from("uploads").getPublicUrl(path);
      comprobanteUrl = urlData.publicUrl;
    }

    const { data: nuevoPago, error: insertError } = await supabase
      .from("pagos")
      .insert({
        casa_id: SESSION.casa.id,
        tipo,
        mes,
        monto,
        concepto,
        comprobante_url: comprobanteUrl,
        folio,
        estatus: "PENDIENTE"
      })
      .select("*")
      .single();

    if (insertError) {
      console.error("Error al registrar pago", insertError);
      alert("Error al registrar pago");
      return;
    }

    ui.folioText.innerHTML = `
      <b>Pago registrado correctamente</b><br>
      Folio: <b>${nuevoPago.folio}</b><br>
      Pendiente de validación<br>
      Toma screenshot de esta pantalla
    `;
    show(ui.folioBox);
  } finally {
    ui.btnPago.disabled = false;
  }
}

function aceptarFolio(){
  ui.pagoArchivo.value = "";
  loadHome();
}

ui.pagoMonto.addEventListener("input", actualizarPagoMontoDisplay);

window.login = login;
window.registrarCasa = registrarCasa;
window.loadHome = loadHome;
window.subirRecibo = subirRecibo;
window.toggleMascotaForm = toggleMascotaForm;
window.guardarMascota = guardarMascota;
window.registrarPago = registrarPago;
window.aceptarFolio = aceptarFolio;
window.onTipoPagoChange = onTipoPagoChange;
</script>
</body>
</html>














</html>














